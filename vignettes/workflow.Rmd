---
title: "Workflow of spatialDE"
author:
- name: Davide Corso
  affiliation: University of Padova
  email: davide.corso.2@phd.unipd.it
date: "`r doc_date()`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
  BiocStyle::html_document:
    self_contained: yes
    toc: yes
    toc_float: yes
    toc_depth: 2
    code_folding: show
  pdf_document:
    toc: yes
    toc_depth: '2'
vignette: |
  %\VignetteIndexEntry{Workflow of spatialDE} 
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Example from original [SpatialDE](https://github.com/Teichlab/SpatialDE): Mouse Olfactory Bulb ([MouseOB](https://github.com/Teichlab/SpatialDE/tree/master/Analysis/MouseOB))
```{r setup}
# library(spatialDE)
```


### Download files
```{r}
# Expression file used in python SpatialDE
# 8.4 Mb
expression_csv <- "Rep11_MOB_0.csv"
download.file("https://media.githubusercontent.com/media/Teichlab/SpatialDE/ad411d51e887575a34c90d3f12fd9c6844e35c9f/Analysis/MouseOB/data/Rep11_MOB_0.csv",
              destfile = expression_csv)

# Sample Info file used in python SpatialDE
# 7 KB
coordinate_csv <- "MOB_sample_info.csv"
download.file("https://media.githubusercontent.com/media/Teichlab/SpatialDE/ad411d51e887575a34c90d3f12fd9c6844e35c9f/Analysis/MouseOB/MOB_sample_info.csv",
              destfile = coordinate_csv)
```


### Loading the `expression_csv` file
```{r}
df <- read.csv(expression_csv, header = TRUE, row.names = 1 )
df[1:5, 1:5]
```

### Loading the `coordinate_csv` file
```{r}
sample_info <- read.csv(coordinate_csv, row.names = 1)
head(sample_info)
```

#### Filter out pratically unobserved genes
```{r}
df <- df[, colSums(df)>=3]
```

#### Get total_counts for every spot
```{r}
sample_info$total_counts <- rowSums(df[, ])
head(sample_info)
```

#### Get coordinates from `sample_info`
```{r}
X<-sample_info[, c('x', 'y')]
head(X)
```

### `NaiveDE.stabilize`
`stabilize` function takes in input a dataframe of expression values with samples in columns and genes in rows. Thus, in this case, we have to transpose the dataframe.
```{r}
tdf <- t(df)

norm_expr <- spatialDE::stabilize(tdf)
as.data.frame(norm_expr)[1:5,1:5]
```

### `NaiveDE.regress_out`
```{r}
resid_expr <- regress_out(sample_info, norm_expr)
as.data.frame(resid_expr)[1:5,1:5]
```

### `SpatialDE.run`
```{r}
# results <- spatialDE::run_spatialDE(X, resid_expr)
# results
```

